version: '3'

tasks:
  publish:
    cmds:
      - poetry publish --build

  dbtr-build:
    cmds:
      - poetry run dbtr remote build --project-dir jaffle-shop --server-url {{.SERVER_URL}}
    requires:
      vars: [SERVER_URL]

  test:
    cmds:
      - SERVER_URL={{.SERVER_URL}} poetry run pytest tests -log_cli=true -log_cli_level=info -vvv
    requires:
      vars: [SERVER_URL]

  cloud_run:
    cmds:
      - poetry run dbtr remote deploy --image europe-docker.pkg.dev/skaff-dbtr/dbt-server/{{.ENV}}:{{.TAG}} --service {{.SERVICE_NAME}} --log-level {{.LOG_LEVEL}}
    requires:
      vars: [ENV, TAG, SERVICE_NAME, LOG_LEVEL]

  image:
    cmds:
      - gcloud builds submit dbtr/server --region={{.LOCATION}} --tag europe-docker.pkg.dev/skaff-dbtr/dbt-server/{{.ENV}}:{{.TAG}} --project skaff-dbtr
    requires:
      vars: [LOCATION, ENV, TAG]
